{% extends 'student/calendar_base.html' %}
{% load lookup %}  {# カスタムフィルターをロード #}

{% block title %}予約カレンダー{% endblock %}

{% block content %}
<h1>予約カレンダー</h1>

<div class="calendar-nav">
  <a href="?week={{ prev_week }}">＜ 前の週</a>
  <span>{{ week_dates.0|date:"Y年n月j日" }} ～ {{ week_dates.6|date:"j日" }}</span>
  <a href="?week={{ next_week }}">次の週 ＞</a>
</div>

<table>
  <thead>
    <tr>
      <th>時間帯＼日付</th>
      {% for d in week_dates %}
        <th>{{ d|date:"j" }}<br>{{ d|date:"D" }}</th>
      {% endfor %}
    </tr>
  </thead>

  <tbody>
    {% for slot in time_slots %}
      <tr>
        <th>{{ slot }}</th>
        {% for d in week_dates %}
          {# key を「YYYY-MM-DD@時間帯」という文字列にしておく #}
          {% with key=d|date:"Y-m-d"|add:"@"|add:slot %}
            {% with slot_obj=slot_map|lookup:key %}
              <td>
                {% if slot_obj %}
                  <a href="{% url 'form' %}?slot={{ slot_obj.id }}">〇</a>
                {% endif %}
              </td>
            {% endwith %}
          {% endwith %}
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
